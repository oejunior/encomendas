<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestão de Entregas — Docce</title>
  <meta name="theme-color" content="#0b0b0b" />

  <style>
    :root{
      --bg:#0b0b0b;
      --card:#141414;
      --card2:#101010;
      --text:#f2f2f2;
      --muted:#b7b7b7;
      --line:#262626;
      --good:#42d17d;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --accent:#ffffff;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(900px 500px at 10% 0%, rgba(255,255,255,.06), transparent 60%),
                  radial-gradient(900px 500px at 90% 20%, rgba(255,255,255,.05), transparent 60%),
                  var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", "Apple Color Emoji","Segoe UI Emoji";
      letter-spacing:.2px;
    }
    a{color:inherit}
    .wrap{max-width:1160px;margin:0 auto;padding:18px 14px 40px}
    header{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:12px 4px 18px;
    }
    .brand{
      display:flex;flex-direction:column;gap:2px;
    }
    .brand h1{margin:0;font-size:18px;font-weight:750}
    .brand p{margin:0;color:var(--muted);font-size:12px}
    .top-actions{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
    }
    .pill{
      display:flex;align-items:center;gap:8px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      padding:8px 10px;border-radius:999px;
      color:var(--muted);
      font-size:12px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
    }
    .card .hd h2{margin:0;font-size:14px;font-weight:780}
    .card .hd .sub{margin-top:3px;color:var(--muted);font-size:12px}
    .card .bd{padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input, select, textarea{
      width:100%;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      padding:10px 11px;border-radius:14px;
      outline:none;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(255,255,255,.25);
      box-shadow: 0 0 0 3px rgba(255,255,255,.06);
    }
    textarea{min-height:74px;resize:vertical}
    .btn{
      cursor:pointer;
      border:none;
      border-radius:14px;
      padding:10px 12px;
      background: rgba(255,255,255,.14);
      color: var(--text);
      font-weight:700;
      transition:.15s transform ease, .15s opacity ease, .15s background ease;
      display:inline-flex;align-items:center;gap:8px;justify-content:center;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.18)}
    .btn:active{transform: translateY(0px); opacity:.9}
    .btn.primary{background: rgba(255,255,255,.95); color:#0b0b0b}
    .btn.primary:hover{background: rgba(255,255,255,.90)}
    .btn.ghost{background: transparent;border:1px solid rgba(255,255,255,.14)}
    .btn.danger{background: rgba(255,107,107,.18); border:1px solid rgba(255,107,107,.28)}
    .btn.good{background: rgba(66,209,125,.18); border:1px solid rgba(66,209,125,.28)}
    .btn.small{padding:8px 10px;border-radius:12px;font-size:12px}
    .sep{height:1px;background:rgba(255,255,255,.10);margin:12px 0}
    .muted{color:var(--muted)}
    .mini{font-size:12px}
    .kpi{
      display:grid;grid-template-columns:1fr 1fr;gap:10px
    }
    .kpi .box{
      padding:12px;border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.24);
    }
    .kpi .box .t{font-size:12px;color:var(--muted)}
    .kpi .box .v{margin-top:6px;font-size:18px;font-weight:820}
    .list{
      display:flex;flex-direction:column;gap:10px;
    }
    .item{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      border-radius:16px;
      overflow:hidden;
    }
    .item .top{
      padding:12px 12px;
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      cursor:pointer;
    }
    .item .top:hover{background: rgba(255,255,255,.04)}
    .item .left{display:flex;flex-direction:column;gap:4px}
    .item .title{font-weight:780}
    .item .meta{color:var(--muted);font-size:12px}
    .item .right{display:flex;gap:8px;align-items:center}
    .tag{
      font-size:11px;color:var(--muted);
      border:1px solid rgba(255,255,255,.14);
      padding:6px 8px;border-radius:999px;
      background: rgba(255,255,255,.05);
      white-space:nowrap;
    }
    .item .details{
      padding:0 12px 12px;
      display:none;
    }
    .item.open .details{display:block}
    .details-grid{
      display:grid;grid-template-columns:1fr 1fr;gap:10px
    }
    @media (max-width: 540px){
      .details-grid{grid-template-columns:1fr}
    }
    .details .field{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      padding:10px;border-radius:14px;
    }
    .details .field .k{font-size:12px;color:var(--muted)}
    .details .field .v{margin-top:6px;font-weight:750}
    .footer-actions{display:flex;gap:10px;flex-wrap:wrap}
    .hint{font-size:12px;color:var(--muted);line-height:1.35}
    .warnbox{
      border:1px dashed rgba(255,255,255,.18);
      padding:10px;border-radius:14px;background: rgba(0,0,0,.18);
      color:var(--muted);font-size:12px
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>Gestão de Entregas</h1>
        <p>Index único • sem aquele bloco extra de “Fechamento do dia / total por entregador” fora do lugar.</p>
      </div>

      <div class="top-actions">
        <div class="pill">
          <span>Data:</span>
          <input id="filterDate" type="date" style="padding:6px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.35);color:var(--text);" />
        </div>
        <button id="btnExport" class="btn ghost small" type="button">Exportar CSV</button>
        <button id="btnReset" class="btn danger small" type="button">Limpar tudo</button>
      </div>
    </header>

    <div class="grid">
      <!-- COLUNA ESQUERDA -->
      <section class="card">
        <div class="hd">
          <div>
            <h2>Nova entrega / encomenda</h2>
            <div class="sub">Cadastre e acompanhe as entregas do dia. Lista colapsável (clique no item para abrir).</div>
          </div>
        </div>

        <div class="bd">
          <div class="row">
            <div>
              <label>Cliente</label>
              <input id="oCustomer" placeholder="Nome do cliente" autocomplete="off" />
            </div>
            <div>
              <label>Tipo</label>
              <select id="oType">
                <option value="entrega">Entrega</option>
                <option value="retirada">Retirada</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Data</label>
              <input id="oDate" type="date" />
            </div>
            <div>
              <label>Hora</label>
              <input id="oTime" type="time" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Valor do pedido</label>
              <input id="oValue" inputmode="decimal" placeholder="Ex: 20 / 20,00 / 20.00" />
            </div>
            <div>
              <label>Taxa de entrega</label>
              <input id="oFee" inputmode="decimal" placeholder="Ex: 5 / 5,00 / 5.00" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Entregador (código)</label>
              <select id="oCourier"></select>
            </div>
            <div>
              <label>Observações</label>
              <input id="oNote" placeholder="Opcional" />
            </div>
          </div>

          <div class="footer-actions" style="margin-top:12px">
            <button id="btnAddOrder" class="btn primary" type="button">Adicionar</button>
            <button id="btnClearForm" class="btn" type="button">Limpar campos</button>
          </div>

          <div class="sep"></div>

          <div class="kpi">
            <div class="box">
              <div class="t">Total em pedidos (dia)</div>
              <div id="kpiOrders" class="v">R$ 0,00</div>
            </div>
            <div class="box">
              <div class="t">Total em taxas (dia)</div>
              <div id="kpiFees" class="v">R$ 0,00</div>
            </div>
          </div>

          <div class="sep"></div>

          <div class="list" id="ordersList"></div>

          <div class="warnbox" style="margin-top:12px">
            <div><b>Dica:</b> se o GitHub estiver dando erro ao salvar, cole as 3 partes por etapas e clique em <span class="mono">Commit changes</span> a cada etapa.</div>
          </div>
        </div>
      </section>

      <!-- COLUNA DIREITA -->
      <aside class="card">
        <div class="hd">
          <div>
            <h2>Entregadores</h2>
            <div class="sub">Cadastro local (LocalStorage). Código sugerido: 4 dígitos.</div>
          </div>
        </div>

        <div class="bd">
          <div class="row">
            <div>
              <label>Código</label>
              <input id="cCode" maxlength="4" placeholder="0001" inputmode="numeric" />
            </div>
            <div>
              <label>Nome</label>
              <input id="cName" placeholder="Nome do entregador" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Telefone</label>
              <input id="cPhone" placeholder="(69) 9xxxx-xxxx" />
            </div>
            <div>
              <label>Chave PIX</label>
              <input id="cPix" placeholder="CPF / e-mail / aleatória" />
            </div>
          </div>

          <div class="footer-actions" style="margin-top:12px">
            <button id="btnAddCourier" class="btn good" type="button">Salvar entregador</button>
            <button id="btnRemoveCourier" class="btn danger" type="button">Remover pelo código</button>
          </div>

          <div class="sep"></div>

          <div>
            <h3 style="margin:0 0 8px;font-size:13px;font-weight:820">Resumo por entregador (dia)</h3>
            <div id="courierSummary" class="list"></div>
          </div>

          <div class="sep"></div>

          <!-- FECHAMENTO (mantido) -->
          <div>
            <h3 style="margin:0 0 8px;font-size:13px;font-weight:820">Fechamento</h3>
            <p class="hint" style="margin:0 0 10px">
              Aqui fica o fechamento do dia (somente o necessário).
            </p>

            <div class="row">
              <button id="btnCloseDay" class="btn primary" type="button">Fechar dia (gera texto)</button>
              <button id="btnCopyClose" class="btn ghost" type="button">Copiar</button>
            </div>

            <div style="margin-top:10px">
              <label>Texto do fechamento</label>
              <textarea id="closeText" readonly placeholder="Clique em “Fechar dia (gera texto)”"></textarea>
            </div>
          </div>

        </div>
      </aside>
    </div>
  </div>
  <script>
    const LS_KEY = "docce_entregas_v1";
    const defaultState = { couriers: [], orders: [] };

    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return structuredClone(defaultState);
        const parsed = JSON.parse(raw);
        if(!parsed || typeof parsed !== "object") return structuredClone(defaultState);
        parsed.couriers = Array.isArray(parsed.couriers) ? parsed.couriers : [];
        parsed.orders = Array.isArray(parsed.orders) ? parsed.orders : [];
        return parsed;
      }catch(e){
        console.error("Erro ao carregar state:", e);
        return structuredClone(defaultState);
      }
    }

    function saveState(){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }

    // ✅ Parse de moeda robusto: aceita "20", "20,00", "20.00", "2.000,50", "2,000.50" etc.
    function parseMoney(input){
      if(input == null) return 0;
      let s = String(input).trim();

      // remove tudo que não seja dígito, vírgula, ponto, sinal
      s = s.replace(/[^\d.,-]/g, "");
      if(!s) return 0;

      const hasComma = s.includes(",");
      const hasDot = s.includes(".");

      if(hasComma && hasDot){
        // O separador decimal normalmente é o último entre , e .
        const lastComma = s.lastIndexOf(",");
        const lastDot = s.lastIndexOf(".");
        const decSep = lastComma > lastDot ? "," : ".";
        const thouSep = decSep === "," ? "." : ",";
        s = s.split(thouSep).join("");  // remove milhares
        s = s.replace(decSep, ".");     // normaliza decimal
      }else if(hasComma && !hasDot){
        // Assume vírgula como decimal (pt-BR)
        s = s.replace(/\./g, "");
        s = s.replace(",", ".");
      }else{
        // apenas ponto ou nenhum: assume ponto como decimal
        s = s.replace(/,/g, "");
      }

      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    }

    function fmtMoney(n){
      const lang = navigator.language || "pt-BR";
      try{
        return new Intl.NumberFormat(lang, { style:"currency", currency:"BRL" }).format(n || 0);
      }catch{
        return "R$ " + (n || 0).toFixed(2).replace(".", ",");
      }
    }

    function todayISO(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const da = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${da}`;
    }

    function uid(){
      return Math.random().toString(16).slice(2) + Date.now().toString(16);
    }

    const $ = (id) => document.getElementById(id);

    let state = loadState();

    // Elements
    const filterDate = $("filterDate");
    const oCustomer = $("oCustomer");
    const oType = $("oType");
    const oDate = $("oDate");
    const oTime = $("oTime");
    const oValue = $("oValue");
    const oFee = $("oFee");
    const oCourier = $("oCourier");
    const oNote = $("oNote");

    const ordersList = $("ordersList");
    const kpiOrders = $("kpiOrders");
    const kpiFees = $("kpiFees");
    const courierSummary = $("courierSummary");

    const cCode = $("cCode");
    const cName = $("cName");
    const cPhone = $("cPhone");
    const cPix = $("cPix");

    const closeText = $("closeText");

    // Init
    filterDate.value = todayISO();
    oDate.value = todayISO();

    // Seed courier if none
    if(state.couriers.length === 0){
      state.couriers.push({ code:"0001", name:"Entregador 1", phone:"", pix:"" });
      saveState();
    }

    function normalizeCode(code){
      const digits = String(code || "").replace(/\D/g,"").slice(0,4);
      return digits.padStart(4,"0");
    }

    function getCourierByCode(code){
      return state.couriers.find(c => c.code === code) || null;
    }

    function renderCourierSelect(){
      const selected = oCourier.value;
      oCourier.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "— selecione —";
      oCourier.appendChild(opt0);

      state.couriers
        .slice()
        .sort((a,b)=>a.code.localeCompare(b.code))
        .forEach(c=>{
          const opt = document.createElement("option");
          opt.value = c.code;
          opt.textContent = `${c.code} • ${c.name}`;
          oCourier.appendChild(opt);
        });

      oCourier.value = selected || "";
    }

    function ordersForDay(dateISO){
      return state.orders.filter(o => o.date === dateISO);
    }

    function calcKPIs(dateISO){
      const list = ordersForDay(dateISO);
      const totalOrders = list.reduce((acc,o)=>acc + (o.value || 0), 0);
      const totalFees = list.reduce((acc,o)=>acc + (o.fee || 0), 0);
      kpiOrders.textContent = fmtMoney(totalOrders);
      kpiFees.textContent = fmtMoney(totalFees);
    }

    function renderOrders(){
      const dateISO = filterDate.value || todayISO();
      const list = ordersForDay(dateISO)
        .slice()
        .sort((a,b)=>{
          const ta = (a.time || "99:99");
          const tb = (b.time || "99:99");
          return ta.localeCompare(tb);
        });

      ordersList.innerHTML = "";
      if(list.length === 0){
        const empty = document.createElement("div");
        empty.className = "warnbox";
        empty.textContent = "Nenhuma entrega cadastrada para esta data.";
        ordersList.appendChild(empty);
        return;
      }

      list.forEach(o=>{
        const courier = getCourierByCode(o.courierCode);
        const courierName = courier ? courier.name : "—";

        const item = document.createElement("div");
        item.className = "item";

        const top = document.createElement("div");
        top.className = "top";

        const left = document.createElement("div");
        left.className = "left";
        left.innerHTML = `
          <div class="title">${(o.customer || "Sem nome")} <span class="tag">${o.type === "retirada" ? "Retirada" : "Entrega"}</span></div>
          <div class="meta">${o.date} • ${o.time || "--:--"} • ${courierName}</div>
        `;

        const right = document.createElement("div");
        right.className = "right";
        right.innerHTML = `
          <span class="tag">Pedido: <b>${fmtMoney(o.value || 0)}</b></span>
          <span class="tag">Taxa: <b>${fmtMoney(o.fee || 0)}</b></span>
        `;

        top.appendChild(left);
        top.appendChild(right);

        const details = document.createElement("div");
        details.className = "details";
        details.innerHTML = `
          <div class="details-grid">
            <div class="field"><div class="k">Cliente</div><div class="v">${o.customer || "—"}</div></div>
            <div class="field"><div class="k">Tipo</div><div class="v">${o.type || "—"}</div></div>
            <div class="field"><div class="k">Data / Hora</div><div class="v">${o.date || "—"} ${o.time || ""}</div></div>
            <div class="field"><div class="k">Entregador</div><div class="v">${courier ? `${courier.code} • ${courier.name}` : "—"}</div></div>
            <div class="field"><div class="k">Telefone</div><div class="v">${courier?.phone || "—"}</div></div>
            <div class="field"><div class="k">PIX</div><div class="v">${courier?.pix || "—"}</div></div>
            <div class="field" style="grid-column:1/-1"><div class="k">Obs.</div><div class="v">${o.note || "—"}</div></div>
          </div>

          <div class="footer-actions" style="margin-top:10px">
            <button class="btn danger small" data-del="${o.id}">Excluir</button>
          </div>
        `;

        top.addEventListener("click", ()=>{
          item.classList.toggle("open");
        });

        item.appendChild(top);
        item.appendChild(details);
        ordersList.appendChild(item);
      });

      // bind delete
      ordersList.querySelectorAll("[data-del]").forEach(btn=>{
        btn.addEventListener("click", (ev)=>{
          ev.stopPropagation();
          const id = btn.getAttribute("data-del");
          state.orders = state.orders.filter(o => o.id !== id);
          saveState();
          refresh();
        });
      });
    }

    function renderCourierSummary(){
      const dateISO = filterDate.value || todayISO();
      const list = ordersForDay(dateISO);

      const map = new Map();
      for(const o of list){
        const code = o.courierCode || "----";
        const prev = map.get(code) || { count:0, fees:0, orders:0 };
        prev.count += 1;
        prev.fees += (o.fee || 0);
        prev.orders += (o.value || 0);
        map.set(code, prev);
      }

      courierSummary.innerHTML = "";
      const codes = Array.from(map.keys()).sort();

      if(codes.length === 0){
        const empty = document.createElement("div");
        empty.className = "warnbox";
        empty.textContent = "Sem entregas para resumir.";
        courierSummary.appendChild(empty);
        return;
      }

      codes.forEach(code=>{
        const c = getCourierByCode(code);
        const data = map.get(code);
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="top" style="cursor:default">
            <div class="left">
              <div class="title">${c ? `${c.code} • ${c.name}` : (code === "----" ? "Sem entregador" : code)}</div>
              <div class="meta">${data.count} entrega(s)</div>
            </div>
            <div class="right">
              <span class="tag">Taxas: <b>${fmtMoney(data.fees)}</b></span>
            </div>
          </div>
        `;
        courierSummary.appendChild(div);
      });
    }

    function refresh(){
      renderCourierSelect();
      calcKPIs(filterDate.value);
      renderOrders();
      renderCourierSummary();
    }

    // Actions
    $("btnClearForm").addEventListener("click", ()=>{
      oCustomer.value = "";
      oType.value = "entrega";
      oDate.value = filterDate.value || todayISO();
      oTime.value = "";
      oValue.value = "";
      oFee.value = "";
      oCourier.value = "";
      oNote.value = "";
      oCustomer.focus();
    });

    $("btnAddOrder").addEventListener("click", ()=>{
      const date = (oDate.value || filterDate.value || todayISO()).trim();
      const time = (oTime.value || "").trim();
      const customer = oCustomer.value.trim();
      const type = oType.value;
      const value = parseMoney(oValue.value);
      const fee = parseMoney(oFee.value);
      const courierCode = oCourier.value || "";
      const note = oNote.value.trim();

      if(!date){
        alert("Informe a data.");
        return;
      }
      if(!customer){
        alert("Informe o nome do cliente.");
        return;
      }
      if(type === "entrega" && !courierCode){
        alert("Selecione o entregador (código).");
        return;
      }

      state.orders.push({
        id: uid(),
        date,
        time,
        customer,
        type,
        value,
        fee,
        courierCode,
        note
      });

      saveState();
      oCustomer.value = "";
      oTime.value = "";
      oValue.value = "";
      oFee.value = "";
      oCourier.value = "";
      oNote.value = "";
      refresh();
    });

    $("btnAddCourier").addEventListener("click", ()=>{
      const code = normalizeCode(cCode.value);
      const name = cName.value.trim();
      const phone = cPhone.value.trim();
      const pix = cPix.value.trim();

      if(!code || code.length !== 4){
        alert("Código inválido. Use 4 dígitos.");
        return;
      }
      if(!name){
        alert("Informe o nome do entregador.");
        return;
      }

      const idx = state.couriers.findIndex(c=>c.code===code);
      const payload = { code, name, phone, pix };

      if(idx >= 0){
        state.couriers[idx] = payload;
      }else{
        state.couriers.push(payload);
      }

      saveState();
      cCode.value = "";
      cName.value = "";
      cPhone.value = "";
      cPix.value = "";
      refresh();
    });

    $("btnRemoveCourier").addEventListener("click", ()=>{
      const code = normalizeCode(cCode.value);
      if(!code || code.length !== 4){
        alert("Informe o código (4 dígitos) no campo Código para remover.");
        return;
      }

      // remove entregador e “solta” entregas (mantém pedido, mas sem entregador)
      state.couriers = state.couriers.filter(c=>c.code !== code);
      state.orders = state.orders.map(o => o.courierCode === code ? ({...o, courierCode:""}) : o);
      saveState();
      refresh();
    });

    filterDate.addEventListener("change", ()=>{
      // sincroniza data do formulário com filtro do dia
      oDate.value = filterDate.value || todayISO();
      refresh();
    });

    $("btnCloseDay").addEventListener("click", ()=>{
      const dateISO = filterDate.value || todayISO();
      const list = ordersForDay(dateISO);

      const totalOrders = list.reduce((acc,o)=>acc + (o.value || 0), 0);
      const totalFees = list.reduce((acc,o)=>acc + (o.fee || 0), 0);

      // por entregador
      const map = new Map();
      for(const o of list){
        if(!o.courierCode) continue;
        const prev = map.get(o.courierCode) || 0;
        map.set(o.courierCode, prev + (o.fee || 0));
      }

      const lines = [];
      lines.push(`FECHAMENTO — ${dateISO}`);
      lines.push(`Total em pedidos: ${fmtMoney(totalOrders)}`);
      lines.push(`Total em taxas: ${fmtMoney(totalFees)}`);
      if(map.size){
        lines.push(``);
        lines.push(`Taxas por entregador:`);
        Array.from(map.entries()).sort((a,b)=>a[0].localeCompare(b[0])).forEach(([code, fees])=>{
          const c = getCourierByCode(code);
          lines.push(`- ${code} ${c ? "• "+c.name : ""}: ${fmtMoney(fees)}`);
        });
      }

      closeText.value = lines.join("\n");
    });

    $("btnCopyClose").addEventListener("click", async ()=>{
      const text = closeText.value || "";
      if(!text){
        alert("Nada para copiar ainda. Clique em “Fechar dia (gera texto)”.");
        return;
      }
      try{
        await navigator.clipboard.writeText(text);
        alert("Fechamento copiado!");
      }catch{
        // fallback
        closeText.focus();
        closeText.select();
        document.execCommand("copy");
        alert("Fechamento copiado!");
      }
    });

    $("btnExport").addEventListener("click", ()=>{
      const dateISO = filterDate.value || todayISO();
      const list = ordersForDay(dateISO);

      const header = ["date","time","customer","type","value","fee","courierCode","note"];
      const rows = [header.join(",")];

      list.forEach(o=>{
        const row = [
          o.date || "",
          o.time || "",
          (o.customer || "").replaceAll('"','""'),
          o.type || "",
          String(o.value || 0),
          String(o.fee || 0),
          o.courierCode || "",
          (o.note || "").replaceAll('"','""'),
        ].map(v => `"${v}"`);
        rows.push(row.join(","));
      });

      const blob = new Blob([rows.join("\n")], { type:"text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `entregas_${dateISO}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    $("btnReset").addEventListener("click", ()=>{
      const ok = confirm("Isso vai apagar TUDO (entregadores e entregas) neste navegador. Confirmar?");
      if(!ok) return;
      state = structuredClone(defaultState);
      saveState();
      refresh();
    });

    // First render
    refresh();
  </script>
</body>
</html>
